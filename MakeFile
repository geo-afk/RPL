.PHONY: help build test run deploy clean install

# Colors for output
GREEN  := $(shell tput -Txterm setaf 2)
YELLOW := $(shell tput -Txterm setaf 3)
WHITE  := $(shell tput -Txterm setaf 7)
CYAN   := $(shell tput -Txterm setaf 6)
RESET  := $(shell tput -Txterm sgr0)

help: ## Show this help message
	@echo ''
	@echo 'Usage:'
	@echo '  ${YELLOW}make${RESET} ${GREEN}<target>${RESET}'
	@echo ''
	@echo 'Targets:'
	@awk 'BEGIN {FS = ":.*?## "} { \
		if (/^[a-zA-Z_-]+:.*?##.*$$/) {printf "    ${YELLOW}%-20s${GREEN}%s${RESET}\n", $$1, $$2} \
		else if (/^## .*$$/) {printf "  ${CYAN}%s${RESET}\n", substr($$1,4)} \
		}' $(MAKEFILE_LIST)

## Development

install: ## Install dependencies
	@echo "${GREEN}Installing dependencies...${RESET}"
	pip install -r requirements/dev.txt
	pip install -r requirements/test.txt
	@echo "${GREEN}✓ Dependencies installed${RESET}"

setup: ## Set up development environment
	@echo "${GREEN}Setting up development environment...${RESET}"
	make install
	make build-parser
	cp .env.example .env
	@echo "${GREEN}✓ Development environment ready${RESET}"

build-parser: ## Generate ANTLR parser
	@echo "${GREEN}Generating parser from grammar...${RESET}"
	mkdir -p generated
	java -jar /usr/local/lib/antlr-4.13.1-complete.jar \
		-Dlanguage=Python3 -visitor -no-listener \
		-o generated grammar/SPL.g4
	@echo "${GREEN}✓ Parser generated${RESET}"

## Testing

test: ## Run all tests
	@echo "${GREEN}Running tests...${RESET}"
	pytest tests/ -v --cov=api --cov=core --cov-report=html
	@echo "${GREEN}✓ Tests complete${RESET}"

test-unit: ## Run unit tests only
	@echo "${GREEN}Running unit tests...${RESET}"
	pytest tests/unit/ -v
	@echo "${GREEN}✓ Unit tests complete${RESET}"

test-integration: ## Run integration tests only
	@echo "${GREEN}Running integration tests...${RESET}"
	pytest tests/integration/ -v
	@echo "${GREEN}✓ Integration tests complete${RESET}"

test-e2e: ## Run end-to-end tests
	@echo "${GREEN}Running E2E tests...${RESET}"
	pytest tests/e2e/ -v
	@echo "${GREEN}✓ E2E tests complete${RESET}"

test-watch: ## Run tests in watch mode
	@echo "${GREEN}Running tests in watch mode...${RESET}"
	pytest-watch tests/ -v

lint: ## Run code linting
	@echo "${GREEN}Running linters...${RESET}"
	black --check api/ core/ tests/
	flake8 api/ core/ tests/
	mypy api/ core/
	@echo "${GREEN}✓ Linting complete${RESET}"

format: ## Format code
	@echo "${GREEN}Formatting code...${RESET}"
	black api/ core/ tests/
	isort api/ core/ tests/
	@echo "${GREEN}✓ Code formatted${RESET}"

## Running

run: ## Run development server
	@echo "${GREEN}Starting development server...${RESET}"
	uvicorn api.main:app --reload --host 0.0.0.0 --port 8000

run-worker: ## Run Celery worker
	@echo "${GREEN}Starting Celery worker...${RESET}"
	celery -A core.tasks worker --loglevel=info

shell: ## Start Python shell with context
	@echo "${GREEN}Starting Python shell...${RESET}"
	python -i scripts/shell.py

## Docker

docker-build: ## Build Docker images
	@echo "${GREEN}Building Docker images...${RESET}"
	docker-compose build
	@echo "${GREEN}✓ Docker images built${RESET}"

docker-up: ## Start Docker services
	@echo "${GREEN}Starting Docker services...${RESET}"
	docker-compose up -d
	@echo "${GREEN}✓ Services started${RESET}"
	@echo "${CYAN}API: http://localhost:8000${RESET}"
	@echo "${CYAN}Grafana: http://localhost:3000${RESET}"
	@echo "${CYAN}Adminer: http://localhost:8080${RESET}"

docker-down: ## Stop Docker services
	@echo "${GREEN}Stopping Docker services...${RESET}"
	docker-compose down
	@echo "${GREEN}✓ Services stopped${RESET}"

docker-logs: ## View Docker logs
	docker-compose logs -f

docker-ps: ## Show running containers
	docker-compose ps

docker-restart: ## Restart Docker services
	@echo "${GREEN}Restarting Docker services...${RESET}"
	docker-compose restart
	@echo "${GREEN}✓ Services restarted${RESET}"

docker-clean: ## Clean Docker resources
	@echo "${GREEN}Cleaning Docker resources...${RESET}"
	docker-compose down -v
	docker system prune -f
	@echo "${GREEN}✓ Docker cleaned${RESET}"

## Database

db-migrate: ## Run database migrations
	@echo "${GREEN}Running database migrations...${RESET}"
	alembic upgrade head
	@echo "${GREEN}✓ Migrations complete${RESET}"

db-migrate-create: ## Create new migration
	@read -p "Migration name: " name; \
	alembic revision --autogenerate -m "$$name"

db-reset: ## Reset database
	@echo "${YELLOW}⚠️  This will delete all data!${RESET}"
	@read -p "Are you sure? (y/N): " confirm; \
	if [ "$$confirm" = "y" ]; then \
		alembic downgrade base; \
		alembic upgrade head; \
		echo "${GREEN}✓ Database reset${RESET}"; \
	fi

db-shell: ## Connect to database shell
	docker-compose exec postgres psql -U spl_user -d spl_db

## Deployment

deploy-staging: ## Deploy to staging
	@echo "${GREEN}Deploying to staging...${RESET}"
	./scripts/deploy_staging.sh
	@echo "${GREEN}✓ Deployed to staging${RESET}"

deploy-production: ## Deploy to production
	@echo "${YELLOW}⚠️  Deploying to production!${RESET}"
	@read -p "Are you sure? (y/N): " confirm; \
	if [ "$$confirm" = "y" ]; then \
		./scripts/deploy_production.sh; \
		echo "${GREEN}✓ Deployed to production${RESET}"; \
	fi

## Monitoring

logs: ## View application logs
	tail -f logs/app.log

logs-error: ## View error logs
	tail -f logs/error.log

metrics: ## View metrics
	@echo "${CYAN}Opening Grafana...${RESET}"
	open http://localhost:3000

## Utilities

generate-test-data: ## Generate test data
	@echo "${GREEN}Generating test data...${RESET}"
	python scripts/generate_test_data.py
	@echo "${GREEN}✓ Test data generated${RESET}"

benchmark: ## Run performance benchmarks
	@echo "${GREEN}Running benchmarks...${RESET}"
	python scripts/benchmark.py
	@echo "${GREEN}✓ Benchmarks complete${RESET}"

security-scan: ## Run security scan
	@echo "${GREEN}Running security scan...${RESET}"
	bandit -r api/ core/
	safety check
	@echo "${GREEN}✓ Security scan complete${RESET}"

docs: ## Generate documentation
	@echo "${GREEN}Generating documentation...${RESET}"
	cd docs && make html
	@echo "${GREEN}✓ Documentation generated${RESET}"
	@echo "${CYAN}Docs: docs/_build/html/index.html${RESET}"

clean: ## Clean generated files
	@echo "${GREEN}Cleaning...${RESET}"
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.coverage" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	rm -rf dist/ build/
	@echo "${GREEN}✓ Cleaned${RESET}"

## Default

all: install build-parser test ## Install, build, and test

.DEFAULT_GOAL := help